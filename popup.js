document.addEventListener("DOMContentLoaded", function () {
  const startButton = document.getElementById("startCrawl");
  const stopButton = document.getElementById("stopCrawl");
  const exportButton = document.getElementById("exportData");
  const clearButton = document.getElementById("clearData");
  const statusDiv = document.getElementById("status");
  const progressDiv = document.getElementById("progress");
  const crawledCountSpan = document.getElementById("crawledCount");
  const autoClickStatusSpan = document.getElementById("autoClickStatus");
  const autoScrollStatusSpan = document.getElementById("autoScrollStatus");
  const currentItemSpan = document.getElementById("currentItem");
  const totalItemsSpan = document.getElementById("totalItems");
  const resumeButton = document.getElementById("resumeCrawl");
  const searchButton = document.getElementById("searchButton");
  const searchKeywordInput = document.getElementById("searchKeyword");

  searchButton.addEventListener("click", function () {
    const keyword = searchKeywordInput.value.trim();
    if (!keyword) {
      showStatus("Vui l√≤ng nh·∫≠p t·ª´ kh√≥a t√¨m ki·∫øm!", "error");
      return;
    }

    chrome.tabs.query({ active: true, currentWindow: true }, function (tabs) {
      chrome.tabs.sendMessage(
        tabs[0].id,
        { action: "searchKeyword", keyword: keyword },
        function (response) {
          if (chrome.runtime.lastError) {
            showStatus(
              "Kh√¥ng th·ªÉ g·ª≠i l·ªánh t√¨m ki·∫øm. H√£y m·ªü l·∫°i Google Maps.",
              "error"
            );
            return;
          }
          if (response && response.success) {
            showStatus("ƒê√£ g·ª≠i t·ª´ kh√≥a t√¨m ki·∫øm, ƒë·ª£i crawl...", "success");
          } else {
            showStatus("T√¨m ki·∫øm th·∫•t b·∫°i.", "error");
          }
        }
      );
    });
  });

  // Ki·ªÉm tra xem c√≥ ƒëang ·ªü trang Google Maps kh√¥ng
  chrome.tabs.query({ active: true, currentWindow: true }, function (tabs) {
    const currentTab = tabs[0];
    if (currentTab.url.includes("google.com/maps")) {
      showStatus("ƒêang ·ªü trang Google Maps", "success");
    } else {
      showStatus("Vui l√≤ng m·ªü Google Maps ƒë·ªÉ s·ª≠ d·ª•ng extension", "error");
      startButton.disabled = true;
    }
  });

  // B·∫Øt ƒë·∫ßu crawl
  startButton.addEventListener("click", function () {
    chrome.tabs.query({ active: true, currentWindow: true }, function (tabs) {
      chrome.tabs.sendMessage(
        tabs[0].id,
        { action: "startCrawl" },
        function (response) {
          if (response && response.success) {
            showStatus("ƒê√£ b·∫Øt ƒë·∫ßu crawl d·ªØ li·ªáu", "success");
            startButton.disabled = true;
            stopButton.disabled = false;
            progressDiv.style.display = "block";
          } else {
            showStatus("Kh√¥ng th·ªÉ b·∫Øt ƒë·∫ßu crawl. Vui l√≤ng th·ª≠ l·∫°i.", "error");
          }
        }
      );
    });
  });

  // D·ª´ng crawl
  stopButton.addEventListener("click", function () {
    chrome.tabs.query({ active: true, currentWindow: true }, function (tabs) {
      chrome.tabs.sendMessage(
        tabs[0].id,
        { action: "stopCrawl" },
        function (response) {
          if (response && response.success) {
            showStatus("ƒê√£ d·ª´ng crawl d·ªØ li·ªáu", "info");
            startButton.disabled = false;
            stopButton.disabled = true;
          } else {
            showStatus("Kh√¥ng th·ªÉ d·ª´ng crawl. Vui l√≤ng th·ª≠ l·∫°i.", "error");
          }
        }
      );
    });
  });

  // Xu·∫•t d·ªØ li·ªáu
  // exportButton.addEventListener("click", function () {
  //   chrome.storage.local.get(["crawledData"], function (result) {
  //     if (result.crawledData && result.crawledData.length > 0) {
  //       try {
  //         const dataStr = JSON.stringify(result.crawledData, null, 2);
  //         const dataBlob = new Blob([dataStr], { type: "application/json" });
  //         const url = URL.createObjectURL(dataBlob);

  //         chrome.downloads.download(
  //           {
  //             url: url,
  //             filename: "google_maps_data.json",
  //             saveAs: true,
  //           },
  //           function (downloadId) {
  //             if (chrome.runtime.lastError) {
  //               console.error("L·ªói download:", chrome.runtime.lastError);
  //               showStatus(
  //                 "L·ªói khi xu·∫•t d·ªØ li·ªáu: " + chrome.runtime.lastError.message,
  //                 "error"
  //               );
  //             } else {
  //               showStatus("ƒê√£ xu·∫•t d·ªØ li·ªáu th√†nh c√¥ng", "success");
  //             }
  //           }
  //         );
  //       } catch (error) {
  //         console.error("L·ªói khi t·∫°o file:", error);
  //         showStatus("L·ªói khi t·∫°o file d·ªØ li·ªáu", "error");
  //       }
  //     } else {
  //       showStatus("Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t", "error");
  //     }
  //   });
  // });
  exportButton.addEventListener("click", function () {
    chrome.storage.local.get(["crawledData"], function (result) {
      const raw = result.crawledData || [];

      if (raw.length === 0) {
        showStatus("Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t", "error");
        return;
      }

      // H√†m t√°ch ƒë·ªãa ch·ªâ th√†nh c√°c ph·∫ßn
      function parseAddress(address) {
        if (!address) return {};
        address = address
          .replace(/,\s*Vi·ªát Nam/i, "")
          .replace(/\d{5,6}/g, "")
          .trim();
        const parts = address.split(",").map((p) => p.trim());
        const partLen = parts.length;

        let street = "",
          ward = "",
          district = "",
          city = "";
        if (partLen >= 4) {
          city = parts[partLen - 1];
          district = parts[partLen - 2];
          ward = parts[partLen - 3];
          street = parts.slice(0, partLen - 3).join(", ");
        } else if (partLen === 3) {
          city = parts[2];
          district = parts[1];
          street = parts[0];
        } else {
          street = address;
        }

        return {
          street,
          ward,
          district,
          city,
        };
      }

      // üßπ 1. L√†m s·∫°ch v√† ƒë·ªãnh d·∫°ng l·∫°i d·ªØ li·ªáu
      const cleanedData = raw.map((item, index) => {
        const cleanText = (text) =>
          typeof text === "string"
            ? text.replace(/^[^\w\d\s]+/g, "").trim()
            : "";

        // Format s·ªë ƒëi·ªán tho·∫°i
        let phone = item.phone || "";
        if (phone.startsWith("+84")) {
          phone = "0" + phone.slice(3);
        } else if (phone.startsWith("84")) {
          phone = "0" + phone.slice(2);
        }

        // Format ng√†y
        let date = "";
        try {
          date = new Date(item.timestamp).toLocaleDateString("vi-VN");
        } catch {}

        // T√°ch ƒë·ªãa ch·ªâ
        const { street, ward, district, city } = parseAddress(
          item.address || ""
        );

        return {
          STT: index + 1,
          NAME: cleanText(item.name),
          STREET: cleanText(street),
          WARD: cleanText(ward),
          DISTRICT: cleanText(district),
          CITY: cleanText(city),
          CATEGORY: item.category || "",
          DESCRIPTION: item.description || "",
          FACEBOOK: item.facebook || "",
          WEBSITE: item.website || "",
          PHONE: phone,
          OPENING_HOURS: item.openingHours || "",
          RATING: item.rating || "",
          REVIEWS: item.reviews || "",
          TIMESTAMP: date,
        };
      });

      // üßæ 2. T·∫°o worksheet t·ª´ JSON
      const worksheet = XLSX.utils.json_to_sheet(cleanedData);

      // üé® 3. Style ti√™u ƒë·ªÅ
      const headers = Object.keys(cleanedData[0]);
      headers.forEach((key, colIdx) => {
        const cellAddr = XLSX.utils.encode_cell({ r: 0, c: colIdx });
        if (!worksheet[cellAddr]) return;
        worksheet[cellAddr].s = {
          font: { name: "Arial", sz: 16, bold: true },
          alignment: { horizontal: "center", vertical: "center" },
        };
      });

      // üíÖ 4. Style d·ªØ li·ªáu
      const range = XLSX.utils.decode_range(worksheet["!ref"]);
      for (let R = 1; R <= range.e.r; ++R) {
        for (let C = 0; C <= range.e.c; ++C) {
          const addr = XLSX.utils.encode_cell({ r: R, c: C });
          if (worksheet[addr]) {
            worksheet[addr].s = {
              font: { name: "Arial", sz: 16 },
              alignment: { vertical: "center" },
            };
          }
        }
      }

      // üìè 5. Set ƒë·ªô r·ªông c·ªôt
      worksheet["!cols"] = headers.map(() => ({ wch: 25 }));

      // üìö 6. T·∫°o file Excel
      const workbook = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(workbook, worksheet, "Google Maps Data");

      const buffer = XLSX.write(workbook, {
        bookType: "xlsx",
        type: "array",
        cellStyles: true,
      });
      const blob = new Blob([buffer], { type: "application/octet-stream" });
      const url = URL.createObjectURL(blob);

      chrome.downloads.download(
        {
          url: url,
          filename: "google_maps_data.xlsx",
          saveAs: true,
        },
        function (downloadId) {
          if (chrome.runtime.lastError) {
            console.error("L·ªói download:", chrome.runtime.lastError);
            showStatus(
              "L·ªói khi xu·∫•t d·ªØ li·ªáu: " + chrome.runtime.lastError.message,
              "error"
            );
          } else {
            showStatus("‚úÖ ƒê√£ xu·∫•t Excel c√≥ ƒë·ªãnh d·∫°ng chu·∫©n", "success");
          }
        }
      );
    });
  });

  // X√≥a d·ªØ li·ªáu
  clearButton.addEventListener("click", function () {
    if (confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a t·∫•t c·∫£ d·ªØ li·ªáu ƒë√£ crawl?")) {
      chrome.storage.local.set({ crawledData: [] }, function () {
        showStatus("ƒê√£ x√≥a t·∫•t c·∫£ d·ªØ li·ªáu", "success");
        updateCrawledCount();
      });
    }
  });

  // Khi m·ªü popup, ki·ªÉm tra tr·∫°ng th√°i resumeNeeded
  chrome.storage.local.get(["resumeNeeded"], function (result) {
    if (result.resumeNeeded) {
      resumeButton.style.display = "block";
      showStatus(
        "Extension b·ªã reload ho·∫∑c trang b·ªã l√†m m·ªõi. B·∫•m 'Ti·∫øp t·ª•c Crawl' ƒë·ªÉ ti·∫øp t·ª•c.",
        "error"
      );
      startButton.disabled = true;
      stopButton.disabled = true;
    }
  });

  // Th√™m s·ª± ki·ªán cho n√∫t Ti·∫øp t·ª•c Crawl
  resumeButton.addEventListener("click", function () {
    chrome.tabs.query({ active: true, currentWindow: true }, function (tabs) {
      chrome.tabs.sendMessage(
        tabs[0].id,
        { action: "resumeCrawl" },
        function (response) {
          if (chrome.runtime.lastError) {
            showStatus(
              "Kh√¥ng th·ªÉ k·∫øt n·ªëi t·ªõi trang Google Maps. Vui l√≤ng reload l·∫°i trang r·ªìi b·∫•m 'Ti·∫øp t·ª•c Crawl'!",
              "error"
            );
            return;
          }
          if (response && response.success) {
            showStatus("ƒê√£ ti·∫øp t·ª•c crawl d·ªØ li·ªáu", "success");
            resumeButton.style.display = "none";
            startButton.disabled = true;
            stopButton.disabled = false;
            progressDiv.style.display = "block";
            chrome.storage.local.set({ resumeNeeded: false });
          } else {
            showStatus("Kh√¥ng th·ªÉ ti·∫øp t·ª•c crawl. Vui l√≤ng th·ª≠ l·∫°i.", "error");
          }
        }
      );
    });
  });

  // C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng ƒë√£ crawl
  function updateCrawledCount() {
    chrome.storage.local.get(["crawledData"], function (result) {
      const count = result.crawledData ? result.crawledData.length : 0;
      crawledCountSpan.textContent = count;
    });
  }

  // C·∫≠p nh·∫≠t th√¥ng tin auto click v√† scroll
  function updateAutoClickInfo() {
    chrome.tabs.query({ active: true, currentWindow: true }, function (tabs) {
      chrome.tabs.sendMessage(
        tabs[0].id,
        { action: "getAutoClickInfo" },
        function (response) {
          if (response && response.success) {
            autoClickStatusSpan.textContent = response.isAutoClicking
              ? "ƒêang ch·∫°y..."
              : "ƒê√£ d·ª´ng";
            autoScrollStatusSpan.textContent = response.isAutoScrolling
              ? "ƒêang ch·∫°y..."
              : "ƒê√£ d·ª´ng";
            currentItemSpan.textContent = response.currentIndex || 0;
            totalItemsSpan.textContent = response.totalItems || 0;
          }
        }
      );
    });
  }

  // Hi·ªÉn th·ªã status
  function showStatus(message, type) {
    statusDiv.textContent = message;
    statusDiv.className = `status ${type}`;
    statusDiv.style.display = "block";

    setTimeout(() => {
      statusDiv.style.display = "none";
    }, 3000);
  }

  // L·∫Øng nghe th√¥ng b√°o t·ª´ content script
  chrome.runtime.onMessage.addListener(function (
    request,
    sender,
    sendResponse
  ) {
    if (request.action === "updateCount") {
      updateCrawledCount();
    }
    // N·∫øu nh·∫≠n ƒë∆∞·ª£c th√¥ng b√°o context invalidated, hi·ªán n√∫t ti·∫øp t·ª•c crawl
    if (request.action === "showResumeCrawl") {
      resumeButton.style.display = "block";
      showStatus(
        "Extension b·ªã reload ho·∫∑c trang b·ªã l√†m m·ªõi. B·∫•m 'Ti·∫øp t·ª•c Crawl' ƒë·ªÉ ti·∫øp t·ª•c.",
        "error"
      );
      startButton.disabled = true;
      stopButton.disabled = true;
    }
  });

  // C·∫≠p nh·∫≠t count ban ƒë·∫ßu
  updateCrawledCount();

  // C·∫≠p nh·∫≠t th√¥ng tin auto click ƒë·ªãnh k·ª≥
  setInterval(updateAutoClickInfo, 2000);
  updateAutoClickInfo();
});
